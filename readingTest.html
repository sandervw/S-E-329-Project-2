<html>
 <head>
   <!--Stylesheet Import -->
  <link rel="stylesheet" href="css\style.css"/>
  <!-- JQuery Javascript -->
  <script src="js\jquery-3.1.1.min.js"></script>

  <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
  <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
  
  <!-- JQuery UI Javascript -->
  <script src="js\jquery-ui-1.12.1\jquery-ui.js"></script>
  <!-- JQuery UI Stylesheet Import -->
  <link rel="stylesheet" href="js\jquery-ui-1.12.1\jquery-ui.css"/>

  <!-- Bootstrap Stylesheet Import -->
  <link rel="stylesheet" href="js\bootstrap-3.3.7-dist\css\bootstrap.css"/>
  <!-- Bootstrap Javascript Import -->
  <script src="js\bootstrap-3.3.7-dist\js\bootstrap.js" ></script>
 
  <script type="application/javascript">
var intervalId;
var ID_GLOBAL = 0;
var rooms = {}; //Treat this as a map

var diff = 1;
var amount = 5; //Default value
var lastend = Math.PI * 3/2;
var onExpireLoad;
var DEFAULT_POINT_VAL = 10;
var score = 0;// -15;//You get 15 for the first slide
start = new Date().getTime();
var time = Math.round((new Date().getTime() - start)/1000)  

this.init = function init(){
	var star = document.getElementById("beginbtn");
	star.style.visibility = "hidden";
	var slide = document.getElementById("difficulty");
	slide.innerHTML = "";
	
	var nxts = [];
	
	//Start room
	var tmp = new nxttile("wait_for_police", "Call the police");
	nxts.push(tmp);
	tmp = new nxttile("ignore_break_glass", "Ignore the sound");
	nxts.push(tmp);
	tmp = new nxttile("three_men_robbing", "Investigate the noise");
	nxts.push(tmp);
	var path = "images/reading/desk.png"
	var t = new tile("start_room", "You're a security guard at a large museum. It's just after midnight, halfway through your shift. You hear a noise like glass breaking in the distance", nxts, 5, path,"", 0, 0);
	nxts = [];
	
	//Call police
	tmp = new nxttile("hang_up_and_investigate", "Hang up and investigate");
	nxts.push(tmp);
	path = "images/reading/phone.png"
	new tile("wait_for_police", "The dispatcher asks you your name, location, and nature of your emergency. She asks you to stay on the line until an officer can arrive.", nxts, 5 * 60, path);
	nxts = [];
	
	//hang up and investigate
	path = "images/reading/van.png"
	new tile("hang_up_and_investigate", "The criminals were fast. The time you wasted on the phone was enough for them to get away, leaving no trace except for a black van speeding off into the night. The police question you, but their investigation turns up nothing. You're fired within the month.", nxts, 0, path);
	nxts = [];
	
	//Ignore the noise
	path = "images/reading/theft.png"
	new tile("ignore_break_glass", "Aside from a few creaks, bumps, and squeaky hinges (normal museum noises, you're sure), you have a quiet night. The next day the curator arrives and discovers almost $300,000 worth of theft. You are fired for your negligence, and struggle to find another job.", nxts, 0, path);
	nxts = [];
	
	//Investigate the noise
	tmp = new nxttile("sneak_away", "Sneak away back to your desk");
	nxts.push(tmp);
	tmp = new nxttile("confront_robbers", "Announce your presence and arrest them");
	nxts.push(tmp);
	path = "images/reading/masks.png"
	new tile("three_men_robbing", "You see three men in the Egyptian Jewels exhibit. They are wearing ski masks and are filling burlap sacks with ancient jewels. You do not believe they see you.", nxts, 10, path);
	nxts = [];
	
	//sneak away
	path = "images/reading/hiding.png"
	new tile("sneak_away", "One of the robbers must have noticed a security guard sneaking away, because the next day the entire museum is cleared out. Several million dollars worthof jewels, paintings, and relic are stolen and appear on the black market over the next few months. You are fired and jailed for your negligence and compliance in the robbery.", nxts, 0, path);
	nxts = [];
	
	//Confront the robbers
	path = "images/reading/cuffs.png"
	new tile("confront_robbers", "The robbers are startled by you. They immediately surrender. The police come, arresting the man. You're interviewed on the news, and receive a promotion the next day.", nxts, 0, path);
	nxts = [];
	
	loadTile(t.name); 
	clock(); 

	intervalId = setInterval(clock, 1000);
}

function show_image(src, width, height, alt) {
    
	var img = document.createElement("img");
    img.src = src;
    img.width = width;
    img.height = height;
    img.alt = alt;

	var pic = document.getElementById('picture');
	pic.innerHTML = "";
	if(src)
	{   
		pic.appendChild(img);
	}

}

//Display text should appear on a button
var nxttile = function(nextname, displaytext)
{
this.nextname = nextname;
this.displaytext = displaytext;
}

//A tile has a scenario text and an array of nxttiles
//It will make a button for each option
//It also has an id
var tile = function(name, scenariotext, options, time, imgpath, onExpireName, pointval, isFinal)
{
	this.name = name;//Tile name, globally unique
	this.scenariotext = scenariotext; //The quesiton displayed
	this.options = options; //List of buttons (text, next tile) that give choices
	this.time = time; //Amount of time to react
	this.img = imgpath; //The image to display
	this.onExpireName = onExpireName; //name of the tile to load if no action is taken. Usually gameover.
	if(pointval)
	{
	this.pointval = pointval; //Points this tile is worth 
	}
	else
	{
		this.pointval = DEFAULT_POINT_VAL;
	}
	this.isFinal = isFinal;
	
	rooms[name] = this;//Add to global map
}

var loadTile = function(name)
{
	console.log( "c")
	console.log( name)
	console.log(rooms);
	context.clearRect(0, 0, canvas.width, canvas.height);
	var tile = rooms[name];//tiles[id];
	console.log(tile)
	var qid = document.getElementById('question');
	var cid = document.getElementById("choices");
	cid.innerHTML = "";
	qid.innerHTML = tile.scenariotext;
	show_image(tile.img, 500,300, "");
	
	console.log( "e")
	
	//reset
	amount = tile.time;
	//lastend = Math.PI * 3/2;
	start = new Date().getTime();
	expired = false;
	
	score += tile.pointval;
	score+= amount - time;
	var myscore = document.getElementById('myscore');
	//myscore.innerHTML = `<b>Score: ${score}</b>`;
	myscore.innerHTML = "<b>Score: " + score + "</b>";
	onExpireLoad = tile.onExpireName;
	
	console.log( "d")
	
	//Load options
	for(i = 0; i < tile.options.length; i++)
	{
		var btn = document.createElement("BUTTON"); 
		btn.next = tile.options[i].nextname;
		btn.onclick = function(){
			loadTile(this.next);
			};
		
		var t = document.createTextNode(tile.options[i].displaytext);
		btn.appendChild(t);

		cid.appendChild(btn);
	}
	
	if(tile.isFinal)
	{
		var bspace = document.getElementById('beginbtn');
		var btn = document.createElement("BUTTON"); 
		btn.onclick = function(){
			//todo
		};
		var t = document.createTextNode("Submit High Score");
		btn.appendChild(t)
		
		bspace.appendChild(btn);
	}
	
}

var start;
var expired = false;

//Called every second
function clock(){
	console.log("hit")
	expired = false;
  // no notification when we get unloaded/replaced, so check here
  canvas = document.getElementById('canvas');
  if (!canvas) {
    clearInterval(intervalId);
    return;
  }

	time = Math.round((new Date().getTime() - start)/1000)      
	lastend = Math.PI * 3/2;
	var context = canvas.getContext('2d');
	
	var centerX = canvas.width / 2;
	var centerY = canvas.height / 2;
	var radius = 70;
	//amount = 5;
	console.log( "a")
	context.beginPath();
	context.arc(centerX, centerY, radius, 0 * Math.PI, 2 * Math.PI, false);
	context.fillStyle = 'red';
	context.lineWidth = 5;
	context.strokeStyle = '#003300';
	context.stroke();
  console.log( "b")
	context.beginPath();
	context.moveTo(canvas.width / 2, canvas.height / 2);
	context.arc(canvas.width / 2, canvas.height / 2, canvas.height / 2, lastend, lastend + (Math.PI * 2 * (time / amount)), false);
	context.lineTo(canvas.width / 2, canvas.height / 2);

	context.fill();

	lastend += (Math.PI * 2 * (time / amount)) % Math.PI;
	 if (time > amount && !expired)//Only trigger expire once. You ran out of time, yo.
	{
		expired = true;
		loadTile(onExpireLoad);
	}
	console.log("go")
}
  </script>
 </head>
 <body>
 <div class="row">
	<div class="col-md-6">
		<canvas id="canvas" width="150" height="150"></canvas>
	</div>
	<div class="col-md-4"></div>
	<div class="col-md-2" id="myscore"></div>
 </div>
	
   <div><br><br></div>
   <center> 
		<div id="picture">Difficulty: 1</div>
		<div id="question"></div>
		<div id="choices"></div>
		<button id="beginbtn" onclick="init()">Start Game</button>
	<div class="row">
		<div class="col-xs-4"></div>
		<div  class="col-xs-4" id="difficulty"></div>
		<div class="col-xs-4" id="amount"></div>
	</div>	
   </center>
 </body>
 <script>
		start = new Date().getTime();
	  $( "#difficulty" ).slider({
      value:1,
      min: 1,
      max: 3,
      step: 1,
      slide: function( event, ui ) {
		var pc = document.getElementById('picture');
		pc.innerHTML = "Difficulty: " + ui.value;
		diff = ui.value;
      }
    });
 </script>
 <script>
	var canvas = document.getElementById('canvas');
	var context = canvas.getContext('2d');
	//this.init();
 </script>
</html>